#-----------------------------------------------#
# ������ ����� ������������ �����
#-----------------------------------------------#

server {
		listen	80;
		server_name kmroot;
		root %hostdir%/html_demo;
		charset utf8;
		index index.php;
		etag on;
		ssi on;
		client_body_timeout 120;
		add_header  X-Robots-Tag "noindex, nofollow, nosnippet, noarchive";

		# 301 редирект со страниц со слешем на страницы без слеша в конце URL
        rewrite ^/(.*)/$ /$1 permanent;

		location / {
			add_header Access-Control-Allow-Origin *;
			try_files $uri @front;
		}
		location @front {
			fastcgi_buffers 256 64k;
			fastcgi_busy_buffers_size 64k;
			fastcgi_temp_file_write_size 64k;
			fastcgi_max_temp_file_size 0;

			fastcgi_read_timeout 360;
			#fastcgi_pass unix:/run/php/php7.1-fpm.sock;
			fastcgi_pass 127.0.0.1:9000;
			fastcgi_split_path_info ^(.+\.php)(/.*)$;
			#include fastcgi_params;
			fastcgi_param REQUEST_URI $uri;
			fastcgi_param SCRIPT_FILENAME $document_root/app.php;
			fastcgi_param DOCUMENT_ROOT /app.php;


#		fastcgi_cache ssi_cache;
#		fastcgi_cache_valid 200 0m;
#		fastcgi_cache_valid 301 302 304 1d;
#		fastcgi_cache_valid 404 0m;
#		fastcgi_cache_valid 500 0m;
#		fastcgi_cache_min_uses 1;
#		fastcgi_cache_use_stale updating error timeout invalid_header http_500;
#		fastcgi_cache_lock on;
#		fastcgi_cache_key $uri;

			internal;
		}
}
	server {
	    listen       80;
	    server_name  kmroot;
	    return       301 http://www.kmroot$request_uri;
	}

server {
		listen	80;
		server_name kmroot;
		root %hostdir%/html_main;
		charset utf8;
		index index.php;
		etag on;
		ssi on;
		client_max_body_size 8m;

		location ~ ^/images/.*\.(?:jpeg|png|gif|jpg)$ {
                        add_header Access-Control-Allow-Origin *;
                        try_files $uri @redirect;
                }

###srart off site
#		location / {
#        		return 503;
#		}
#		location /i/ {
#        		alias /var/www/kino.mania/err/;
#        	}
#		error_page 503 /503.html;
#	        	location = /503.html {
#                	root /var/www/kino.mania/err;
#               	}
###end off site###
	        location / {
                       add_header Access-Control-Allow-Origin *;
                       try_files $uri @front_main;
                }

		location @front_main {
			fastcgi_buffers 256 64k;
			fastcgi_busy_buffers_size 64k;
			fastcgi_temp_file_write_size 64k;
			fastcgi_max_temp_file_size 0;
			fastcgi_read_timeout 60;

			#fastcgi_pass unix:/run/php/php7.1-fpm.sock;
			fastcgi_pass 127.0.0.1:9000;
			fastcgi_split_path_info ^(.+\.php)(/.*)$;
			fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME /scripts$fastcgi_script_name;
			fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
			#include fastcgi_params;

			#fastcgi_pass_header Cookie;
			fastcgi_param REQUEST_URI $uri;
			fastcgi_param SCRIPT_FILENAME $document_root/app.php;
			fastcgi_param DOCUMENT_ROOT /app.php;
			fastcgi_cache ssi_cache;
			fastcgi_cache_valid 200 0m;
			fastcgi_cache_valid 301 302 304 1d;
			fastcgi_cache_valid 404 0m;
			fastcgi_cache_valid 500 0m;
			fastcgi_cache_min_uses 1;
			fastcgi_cache_use_stale updating error timeout invalid_header http_500;
			fastcgi_cache_lock on;
			fastcgi_cache_key $uri;

			internal;
		}


			location @redirect {
                                fastcgi_buffers 256 64k;
                                fastcgi_busy_buffers_size 64k;
                                fastcgi_temp_file_write_size 64k;
                                fastcgi_max_temp_file_size 0;

                                fastcgi_read_timeout 60;

                                #fastcgi_pass unix:/run/php/php7.1-fpm.sock;
                                fastcgi_pass 127.0.0.1:9000;
                                fastcgi_split_path_info ^(.+\.php)(/.*)$;
								fastcgi_index index.php;
                                fastcgi_param SCRIPT_FILENAME /scripts$fastcgi_script_name;
                                fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                                #include fastcgi_params;

                                fastcgi_param REQUEST_UTI $request_uri;
                                fastcgi_param SCRIPT_FILENAME $document_root/redirect.img.php;
                                internal;
                        }


	}

#-----------------------------------------------#
# ����� ����� ������������ �����
#-----------------------------------------------#
